<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Basketball Inference</title>
  <style>
    #video, #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 640px; height: 480px;
    }
    #info {
      position: absolute;
      top: 0; left: 650px;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted></video>
  <canvas id="overlay" width="640" height="480"></canvas>
  <div id="info">
    <div>Score: <span id="score">0</span></div>
  </div>

  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");

    // 1) Запрос камеры
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(e => alert("Не удалось получить доступ к камере: " + e));

    // 2) WebSocket
    const socket = io();

    socket.on("response", data => {
      // очистка
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // рисуем боксы
      ctx.lineWidth = 2;
      ctx.strokeStyle = "lime";
      ctx.font = "18px Arial";
      ctx.fillStyle = "lime";
      for (let b of data.boxes) {
        ctx.strokeRect(b.x1, b.y1, b.x2 - b.x1, b.y2 - b.y1);
        ctx.fillText(b.label, b.x1 + 4, b.y1 + 20);
      }
      // обновляем счёт
      scoreEl.textContent = data.count;
    });

    // 3) Шутинг фреймы каждые 100 мс
    setInterval(() => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const jpeg = canvas.toDataURL("image/jpeg", 0.5);
      socket.emit("frame", jpeg);
    }, 100);
  </script>
</body>
</html>
